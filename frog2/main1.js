if(THREE.WEBGL.isWebGLAvailable()===false){document.body.appendChild(WEBGL.getWebGLErrorMessage())}const e=[];{}const t=[];{t.push("wheel-1");t.push("tire-1");t.push("transmission_hub_front");t.push("transmission_hub_rear");t.push("transmission_main");t.push("transmission_drive_shaft");t.push("frame");t.push("sheet_metal")}const o=new THREE.PerspectiveCamera(40,window.innerWidth/window.innerHeight,1,1e3);const s=new THREE.Scene;const l=new THREE.WebGLRenderer({antialias:true});const _=new THREE.STLLoader;var d;var c;var h;const p=new THREE.MeshPhongMaterial({color:6710886,flatShading:false,side:THREE.DoubleSide});let g={};let w={};let E={};let L={};let k={};k.r=.2;k.g=.3;k.b=.4;var C=12;var M=1.5;var B=-49;var I=218;var V=150;var X=69.67/2;function P(e){var t="data/"+e+".stl";_.load(t,function(t){t.computeBoundingBox();var n=new THREE.Mesh(t,p);s.add(n);Y(s);E[e]={};E[e].mesh=n;E[e].bbox=t.boundingBox})}function W(e){var t="data-ref/"+e+".stl";_.load(t,function(t){t.computeBoundingBox();var n=new THREE.Mesh(t,p);g[e]={};g[e].mesh=n;g[e].bbox=t.boundingBox;if(e==="tire-1")G();if(e==="tire-1")q("tire-1");if(e==="wheel-1")D();if(e.includes("transmission"))A(e);if(e==="frame")$("frame");if(e==="sheet_metal")$("sheet_metal")})}function q(e){vec=g[e].mesh.geometry.attributes.position.array;cnt=g[e].mesh.geometry.attributes.position.count;r=[];for(i=0;i<cnt;i++){x=vec[i*3+0];y=vec[i*3+1];z=vec[i*3+2];r.push(Math.sqrt(x*x+y*y))}r_min=R.reduce(R.min,+1e4,r);r_max=R.reduce(R.max,-1e4,r);g[e].radii=R.map(e=>(e-r_min)/(r_max-r_min),r)}function G(){geom=g["tire-1"].mesh.geometry;var e=new THREE.Mesh(geom.clone(),p);var t=new THREE.Mesh(geom.clone(),p);var n=new THREE.Mesh(geom.clone(),p);var i=new THREE.Mesh(geom.clone(),p);s.add(e);s.add(t);s.add(n);s.add(i);E["tire_lf"]={};E["tire_rf"]={};E["tire_lr"]={};E["tire_rr"]={};E["tire_lf"].mesh=e;E["tire_rf"].mesh=t;E["tire_lr"].mesh=n;E["tire_rr"].mesh=i;N();Y(s)}function N(){E["tire_lf"].mesh.geometry.rotateX(THREE.Math.degToRad(90));E["tire_rf"].mesh.geometry.rotateX(THREE.Math.degToRad(-90));E["tire_lr"].mesh.geometry.rotateX(THREE.Math.degToRad(90));E["tire_rr"].mesh.geometry.rotateX(THREE.Math.degToRad(-90));E["tire_lf"].mesh.position.x=C-I/2;E["tire_lf"].mesh.position.y=M-V/2;E["tire_lf"].mesh.position.z=B+X;E["tire_rf"].mesh.position.x=C-I/2;E["tire_rf"].mesh.position.y=M+V/2;E["tire_rf"].mesh.position.z=B+X;E["tire_lr"].mesh.position.x=C+I/2;E["tire_lr"].mesh.position.y=M-V/2;E["tire_lr"].mesh.position.z=B+X;E["tire_rr"].mesh.position.x=C+I/2;E["tire_rr"].mesh.position.y=M+V/2;E["tire_rr"].mesh.position.z=B+X}function O(){E["wheel_lf"].mesh.geometry.rotateX(THREE.Math.degToRad(90));E["wheel_rf"].mesh.geometry.rotateX(THREE.Math.degToRad(-90));E["wheel_lr"].mesh.geometry.rotateX(THREE.Math.degToRad(90));E["wheel_rr"].mesh.geometry.rotateX(THREE.Math.degToRad(-90));E["wheel_lf"].mesh.position.x=C-I/2;E["wheel_lf"].mesh.position.y=M-V/2;E["wheel_lf"].mesh.position.z=B+X;E["wheel_rf"].mesh.position.x=C-I/2;E["wheel_rf"].mesh.position.y=M+V/2;E["wheel_rf"].mesh.position.z=B+X;E["wheel_lr"].mesh.position.x=C+I/2;E["wheel_lr"].mesh.position.y=M-V/2;E["wheel_lr"].mesh.position.z=B+X;E["wheel_rr"].mesh.position.x=C+I/2;E["wheel_rr"].mesh.position.y=M+V/2;E["wheel_rr"].mesh.position.z=B+X}function D(){geom=g["wheel-1"].mesh.geometry;var e=new THREE.Mesh(geom.clone(),p);var t=new THREE.Mesh(geom.clone(),p);var n=new THREE.Mesh(geom.clone(),p);var i=new THREE.Mesh(geom.clone(),p);s.add(e);s.add(t);s.add(n);s.add(i);E["wheel_lf"]={};E["wheel_rf"]={};E["wheel_lr"]={};E["wheel_rr"]={};E["wheel_lf"].mesh=e;E["wheel_rf"].mesh=t;E["wheel_lr"].mesh=n;E["wheel_rr"].mesh=i;O();Y(s);l.render(s,o)}function A(e){geom=g[e].mesh.geometry;var t=new THREE.Mesh(geom.clone(),p);s.add(t);E[e]={};E[e].mesh=t;Q(e);Y(s);l.render(s,o)}function $(e){geom=g[e].mesh.geometry;var t=new THREE.Mesh(geom.clone(),p);s.add(t);E[e]={};E[e].mesh=t;Y(s);l.render(s,o)}function Q(e){Z(e);var t=L[e].meta.offset;var n=[0,0,0];n[0]=t[0]+Fe.vLF_x[0];n[1]=t[1]+ge;n[2]=t[2]+be;if(e==="transmission_hub_rear")n[0]=t[0]+Fe.vLR_x[0];E[e].mesh.position.x=n[0];E[e].mesh.position.y=n[1];E[e].mesh.position.z=n[2];J(e,n)}function Z(e=null){if(e)L[e]=R.clone(w[e]);if(e)return;const t=(e,t)=>L[t]=R.clone(e);R.forEachObjIndexed(t,w)}function J(e,t){var n=L[e].meta.bbox;for(i in R.range(0,2))for(j in R.range(0,3))n[i][j]+=t[j];var o=L[e].meta.point;const r=(e,n)=>{const o=(e,n)=>{if(n==="pos")for(i in R.range(0,3))e[i]+=t[i]};R.forEachObjIndexed(o,e)};R.forEachObjIndexed(r,o);var a=L[e].meta.deform;const s=(e,n)=>{const o=(e,n)=>{if(n.includes("box")){for(i in R.range(0,2))for(j in R.range(0,3))e[i][j]+=t[j]}};R.forEachObjIndexed(o,e)};R.forEachObjIndexed(s,a)}function K(e){var t=new THREE.Box3;s.traverse(function(e){if(e instanceof THREE.Mesh)t.expandByObject(e)});return t}function U(e,t){var n=0;if(e.isEmpty())console.log("scene empty");if(e.isEmpty())return;var i=new THREE.Vector3;e.getSize(i);var o=new THREE.Vector3;e.getCenter(o);var r=new THREE.Vector3;t.getWorldDirection(r);if(n)console.log("bb:",e,e.getCenter(new THREE.Vector3));if(n)console.log("bb:",i);var a=t.fov*(Math.PI/180);var s=Math.abs(i.length()/Math.sin(a/2));s*=1;if(n)console.log("distance:",s);if(n)console.log("dir:",r);var m=o.add(r.multiplyScalar(-s));if(n)console.log("cam.pos:",t.position);if(n)console.log("pos:",m);t.position.copy(m);if(n)console.log("cam.pos:",t.position);if(n)console.log("far:",t.far);t.far=2*s;if(n)console.log("far:",t.far);t.updateProjectionMatrix()}function Y(e){bb=K(e);U(bb,o)}w={transmission_drive_shaft:null,transmission_hub_front:null,transmission_hub_rear:null,transmission_main:null,frame:null,sheet_metal:null};function ee(e){w.transmission_drive_shaft=e}function te(e){w.transmission_hub_front=e}function ne(e){w.transmission_hub_rear=e}function ie(e){w.transmission_main=e}function oe(e){w.frame=e}function re(e){w.sheet_metal=e}function ae(){l.setPixelRatio(window.devicePixelRatio);l.setSize(.65*window.innerWidth,.65*window.innerHeight);document.getElementById("MyScene").appendChild(l.domElement);d=new THREE.TrackballControls(o,l.domElement);d.rotateSpeed=2.5;d.zoomSpeed=-2.2;d.panSpeed=.8;d.noZoom=false;d.noPan=false;d.staticMoving=true;d.dynamicDampingFactor=.3;d.keys=[65,83,68];d.addEventListener("change",le);s.background=new THREE.Color(13421772);s.background=new THREE.Color(0);s.background.setRGB(.2,.3,.4);h=new THREE.DirectionalLight(16777215);h.position.copy(o.position);s.add(h);var n=new THREE.AmbientLight(16777215);s.add(n);window.addEventListener("resize",se,false);xhr_read_yaml({file:"data-ref/transmission_drive_shaft.yaml",func:ee});xhr_read_yaml({file:"data-ref/transmission_hub_front.yaml",func:te});xhr_read_yaml({file:"data-ref/transmission_hub_rear.yaml",func:ne});xhr_read_yaml({file:"data-ref/transmission_main.yaml",func:ie});xhr_read_yaml({file:"data-ref/frame.yaml",func:oe});xhr_read_yaml({file:"data-ref/sheet_metal.yaml",func:re});for(i in e)P(e[i]);for(i in t)W(t[i]);le()}function se(){o.aspect=window.innerWidth/window.innerHeight;o.updateProjectionMatrix();l.setSize(.65*window.innerWidth,.65*window.innerHeight);d.handleResize();le()}function me(){requestAnimationFrame(me);d.update()}function le(){h.position.copy(o.position);l.render(s,o)}function _e(e){var t=document.getElementById("checkboxes");var n=document.createElement("dl");n.id="checkboxes_dl";var i=document.createElement("dt");i.innerHTML="Part visibility";n.appendChild(i);for(var r=0;r<e.length;r++){var a=e[r];console.log(a);var m=document.createElement("dd");var _=document.createElement("input");_.type="checkbox";_.id="chk"+e[r];_.name="chk"+e[r];_.value="value";_.checked=true;_.onclick=function(e){return function(){checked=document.getElementById("chk"+e).checked;E[e].mesh.visible=checked;l.render(s,o)}}(a);var d=document.createElement("label");d.htmlFor="chk"+e[r];d.appendChild(document.createTextNode(e[r]));m.appendChild(_);m.appendChild(d);n.appendChild(m)}t.appendChild(n)}function de(){var e=document.getElementById("checkboxes_dl");var t=document.createElement("dd");var n=document.createElement("input");n.type="checkbox";n.id="chk_tires";n.name="chk_tires";n.value="value";n.checked=true;n.onclick=function(){checked=document.getElementById("chk_tires").checked;E["tire_lf"].mesh.visible=checked;E["tire_rf"].mesh.visible=checked;E["tire_lr"].mesh.visible=checked;E["tire_rr"].mesh.visible=checked;l.render(s,o)};var i=document.createElement("label");i.htmlFor="chk_tires";i.appendChild(document.createTextNode("tires"));t.appendChild(n);t.appendChild(i);e.appendChild(t)}function ce(){var e=document.getElementById("checkboxes_dl");var t=document.createElement("dd");var n=document.createElement("input");n.type="checkbox";n.id="chk_wheels";n.name="chk_wheels";n.value="value";n.checked=true;n.onclick=function(){checked=document.getElementById("chk_wheels").checked;E["wheel_lf"].mesh.visible=checked;E["wheel_rf"].mesh.visible=checked;E["wheel_lr"].mesh.visible=checked;E["wheel_rr"].mesh.visible=checked;l.render(s,o)};var i=document.createElement("label");i.htmlFor="chk_wheels";i.appendChild(document.createTextNode("wheels"));t.appendChild(n);t.appendChild(i);e.appendChild(t)}function he(){var e=document.getElementById("checkboxes_dl");var t=document.createElement("dd");var n=document.createElement("input");n.type="checkbox";n.id="chk_transmission";n.name="chk_transmission";n.value="value";n.checked=true;n.onclick=function(){checked=document.getElementById("chk_transmission").checked;E["transmission_main"].mesh.visible=checked;E["transmission_hub_rear"].mesh.visible=checked;E["transmission_hub_front"].mesh.visible=checked;E["transmission_drive_shaft"].mesh.visible=checked;l.render(s,o)};var i=document.createElement("label");i.htmlFor="chk_transmission";i.appendChild(document.createTextNode("transmission"));t.appendChild(n);t.appendChild(i);e.appendChild(t)}function fe(){var e=document.getElementById("checkboxes_dl");var t=document.createElement("dd");var n=document.createElement("input");n.type="checkbox";n.id="chk_frame";n.name="chk_frame";n.value="value";n.checked=true;n.onclick=function(){checked=document.getElementById("chk_frame").checked;E["frame"].mesh.visible=checked;l.render(s,o)};var i=document.createElement("label");i.htmlFor="chk_frame";i.appendChild(document.createTextNode("frame"));t.appendChild(n);t.appendChild(i);e.appendChild(t)}function ue(){var e=document.getElementById("checkboxes_dl");var t=document.createElement("dd");var n=document.createElement("input");n.type="checkbox";n.id="chk_sheet_metal";n.name="chk_sheet_metal";n.value="value";n.checked=true;n.onclick=function(){checked=document.getElementById("chk_sheet_metal").checked;E["sheet_metal"].mesh.visible=checked;l.render(s,o)};var i=document.createElement("label");i.htmlFor="chk_sheet_metal";i.appendChild(document.createTextNode("sheet_metal"));t.appendChild(n);t.appendChild(i);e.appendChild(t)}function ve(e,t){var n="color_"+e;console.log(n);var i=document.getElementById(n);var r=document.createElement("label");r.innerHTML=n+":";var a=document.createElement("input");a.type="range";a.min="0";a.max="1";a.step="0.1";a.value=t;a.oninput=function(){k[e]=this.value;document.getElementById(n+"_label").innerHTML=k[e];s.background.setRGB(k.r,k.g,k.b);l.render(s,o)};var m=document.createElement("em");m.id=n+"_label";m.style="font-style: normal";m.innerHTML=t;i.appendChild(r);i.appendChild(a);i.appendChild(m)}_e(e);ue();fe();he();ce();de();ve("r",k.r);ve("g",k.g);ve("b",k.b);ae();me();let pe=0;let ye=1;let xe=[];let Re=12;let ge=1.5;let be=-49;let Te={C_x:[218,0],C_y:[150,0],T_w:[25.39,0],T_h:[12,0],T_d:[69.67,0],H_d:[45.67,0]};let we={T_h_f:1,T_d_f:1,H_d_f:1};let Ee={LF_x:[0,0],LF_y:[0,0],RF_x:[0,0],RF_y:[0,0],LR_x:[0,0],LR_y:[0,0],RR_x:[0,0],RR_y:[0,0],vLF_x:[0,0],vLF_y:[0,0],vRF_x:[0,0],vRF_y:[0,0],vLR_x:[0,0],vLR_y:[0,0],vRR_x:[0,0],vRR_y:[0,0],LF_w:[0,0],vLF_w:[0,0],RF_w:[0,0],vRF_w:[0,0],LR_w:[0,0],vLR_w:[0,0],RR_w:[0,0],vRR_w:[0,0],T_z:[0,0],LF_z:[0,0],vLF_z:[0,0],RF_z:[0,0],vRF_z:[0,0],LR_z:[0,0],vLR_z:[0,0],RR_z:[0,0],vRR_z:[0,0],LF_d:[0,0],RF_d:[0,0],LR_d:[0,0],RR_d:[0,0],LF_h:[0,0],RF_h:[0,0],LR_h:[0,0],RR_h:[0,0]};const He=e=>{const t=new Rx.Subject;return new Proxy(e,{set:(e,n,i)=>{const o=e[n];const r=i;if(typeof i==="object"){if(e[n][1]>i[1]){console.log("name = ",n);throw"stamp error"}else if(e[n][1]==i[1]){}else{e[n]=i;if(ye)t.next({name:n,oldValue:o,newValue:r,target:e});else xe.push({subject:t,arg:{name:n,oldValue:o,newValue:r,target:e}})}}else if(typeof i==="number"){if(ye==1){e[n]=[i,++pe];t.next({name:n,oldValue:o,newValue:r,target:e})}else{throw"bad combo, probably need to send [value,stamp]"}}else{console.log("name = ",n);console.log("type = ",typeof i);throw"need to send object"}},get:(e,n)=>n=="subject"?t:e[n]})};const Le=He(Te);const Fe=He(Ee);f01={next:({name:e,oldValue:t,newValue:n,target:i})=>{if(e=="C_y"){stamp=Le.C_y[1];Fe.LF_y=[ge+Le.C_y[0]/2,stamp];Fe.RF_y=[ge-Le.C_y[0]/2,stamp];Fe.LR_y=Fe.LF_y;Fe.RR_y=Fe.RF_y;Fe.vLF_y=Fe.LF_y;Fe.vRF_y=Fe.RF_y;Fe.vLR_y=Fe.LR_y;Fe.vRR_y=Fe.RR_y}}};f02={next:({name:e,oldValue:t,newValue:n,target:i})=>{if(e=="T_w"){Fe.LF_w=Le.T_w;Fe.RF_w=Le.T_w;Fe.LR_w=Le.T_w;Fe.RR_w=Le.T_w;Fe.vLF_w=Fe.LF_w;Fe.vRF_w=Fe.RF_w;Fe.vLR_w=Fe.LR_w;Fe.vRR_w=Fe.RR_w}}};f03={next:({name:e,oldValue:t,newValue:n,target:i})=>{if(e=="C_x"){stamp=Le.C_x[1];Fe.LF_x=[Re-Le.C_x[0]/2,stamp];Fe.RF_x=Fe.LF_x;Fe.LR_x=[Re+Le.C_x[0]/2,stamp];Fe.RR_x=Fe.LR_x;Fe.vLF_x=Fe.LF_x;Fe.vRF_x=Fe.RF_x;Fe.vLR_x=Fe.LR_x;Fe.vRR_x=Fe.RR_x}}};f04={next:({name:e,oldValue:t,newValue:n,target:i})=>{if(e=="T_z"){Fe.LF_z=Fe.T_z;Fe.RF_z=Fe.T_z;Fe.LR_z=Fe.T_z;Fe.RR_z=Fe.T_z;Fe.vLF_z=Fe.LF_z;Fe.vRF_z=Fe.RF_z;Fe.vLR_z=Fe.LR_z;Fe.vRR_z=Fe.RR_z}}};f05={next:({name:e,oldValue:t,newValue:n,target:i})=>{if(e=="T_d"){stamp=Le.T_d[1];Fe.LF_d=Le.T_d;Fe.RF_d=Le.T_d;Fe.LR_d=Le.T_d;Fe.RR_d=Le.T_d;Fe.T_z=[.5*Le.T_d[0]+be,stamp]}}};f06={next:({name:e,oldValue:t,newValue:n,target:i})=>{if(e=="T_h"){Fe.LF_h=Le.T_h;Fe.RF_h=Le.T_h;Fe.LR_h=Le.T_h;Fe.RR_h=Le.T_h}}};function ke(e,t){i_max=R.reduce(R.max,0,R.pluck(1,e));o_min=R.reduce(R.min,1e6,R.pluck(1,t));return[i_max,o_min]}function ze(){xe=[];ye=0}function Ce(){ye=1;for(a in xe){n=xe[a];n["subject"].next(n["arg"])}}f07={next:({name:e,oldValue:t,newValue:n,target:i})=>{if(R.contains(e,["T_d"])){inputs=[Le.T_d];outputs=[Le.T_h,Le.H_d];stamps=ke(inputs,outputs);if(stamps[0]>stamps[1]){ze();F=we.T_d_f;T=.5*Le.T_d[0];S=Le.T_h[0];H=.5*Le.H_d[0];phi=F*H+(F-1)*S;S=F*T-phi;H=(1-F)*T+phi;stamp=Le.T_d[1];for(let e of inputs)e[1]=stamps[0];Le.T_h=[S,stamps[0]];Le.H_d=[2*H,stamps[0]];Ce()}}}};f08={next:({name:e,oldValue:t,newValue:n,target:i})=>{if(R.contains(e,["T_h"])){inputs=[Le.T_h];outputs=[Le.T_d,Le.H_d];stamps=ke(inputs,outputs);if(stamps[0]>stamps[1]){ze();F=we.T_h_f;T=.5*Le.T_d[0];S=Le.T_h[0];H=.5*Le.H_d[0];phi=(1-F)*H+F*T;T=(1-F)*S+phi;H=-F*S+phi;stamp=Le.T_h[1];Le.T_d=[2*T,stamps[0]];Le.H_d=[2*H,stamps[0]];Ce()}}}};f09={next:({name:e,oldValue:t,newValue:n,target:i})=>{if(R.contains(e,["H_d"])){inputs=[Le.H_d];outputs=[Le.T_d,Le.T_h];stamps=ke(inputs,outputs);if(stamps[0]>stamps[1]){ze();F=we.H_d_f;T=.5*Le.T_d[0];S=Le.T_h[0];H=.5*Le.H_d[0];phi=(1-F)*S+F*T;T=(1-F)*H+phi;S=-F*H+phi;stamp=Le.H_d[1];Le.T_d=[2*T,stamp];Le.T_h=[S,stamp];Ce()}}}};Le.subject.subscribe(f01);Le.subject.subscribe(f02);Le.subject.subscribe(f03);Fe.subject.subscribe(f04);Le.subject.subscribe(f05);Le.subject.subscribe(f06);Le.subject.subscribe(f07);Le.subject.subscribe(f08);Le.subject.subscribe(f09);tol=1e-6;val=Te.T_d[0]-(Te.H_d[0]+2*Te.T_h[0]);if(Math.abs(val)>tol)throw"T_d,H_d,T_h contraint not met";pe++;for(key in Te){console.log(`key = ${key} value = ${Te[key]}`);Le[key]=[Te[key][0],pe]}function Me(){console.log("---");console.log("parameter C-x:",Le.C_x);console.log("RF,RR-xy: (%f,%f) (%f,%f)",Fe.vRF_x[0],Fe.vRF_y[0],Fe.vRR_x[0],Fe.vRR_y[0]);console.log("LF,LR-xy: (%f,%f) (%f,%f)",Fe.vLF_x[0],Fe.vLF_y[0],Fe.vLR_x[0],Fe.vLR_y[0])}Me();function Be(){var e=g["tire-1"].mesh.geometry.clone();w0=25.39;w1=Le.T_w[0]/w0;e.scale(1,1,w1);r0=Le.H_d[0]/2;r1=Le.T_d[0]/2;vec=e.attributes.position.array;cnt=e.attributes.position.count;radii=g["tire-1"].radii;for(i=0;i<cnt;i++){x=vec[i*3+0];y=vec[i*3+1];m=Math.sqrt(x*x+y*y);x/=m;y/=m;r=r0+radii[i]*(r1-r0);vec[i*3+0]=r*x;vec[i*3+1]=r*y}E["tire_lf"].mesh.geometry=e.clone();E["tire_rf"].mesh.geometry=e.clone();E["tire_lr"].mesh.geometry=e.clone();E["tire_rr"].mesh.geometry=e.clone();E["tire_lf"].mesh.geometry.rotateX(THREE.Math.degToRad(-90));E["tire_rf"].mesh.geometry.rotateX(THREE.Math.degToRad(90));E["tire_lr"].mesh.geometry.rotateX(THREE.Math.degToRad(-90));E["tire_rr"].mesh.geometry.rotateX(THREE.Math.degToRad(90))}function Ie(){var e=g["wheel-1"].mesh.geometry.clone();w0=25.39;w1=Le.T_w[0]/w0;d0=45.67;d1=Le.H_d[0]/d0;e.scale(d1,d1,w1);E["wheel_lf"].mesh.geometry=e.clone();E["wheel_rf"].mesh.geometry=e.clone();E["wheel_lr"].mesh.geometry=e.clone();E["wheel_rr"].mesh.geometry=e.clone();E["wheel_lf"].mesh.geometry.rotateX(THREE.Math.degToRad(-90));E["wheel_rf"].mesh.geometry.rotateX(THREE.Math.degToRad(90));E["wheel_lr"].mesh.geometry.rotateX(THREE.Math.degToRad(-90));E["wheel_rr"].mesh.geometry.rotateX(THREE.Math.degToRad(90))}function Ve(){E["tire_lf"].mesh.position.x=Fe.vLF_x[0];E["tire_lf"].mesh.position.y=Fe.vLF_y[0];E["tire_lf"].mesh.position.z=Fe.vLF_z[0];E["tire_rf"].mesh.position.x=Fe.vRF_x[0];E["tire_rf"].mesh.position.y=Fe.vRF_y[0];E["tire_rf"].mesh.position.z=Fe.vRF_z[0];E["tire_lr"].mesh.position.x=Fe.vLR_x[0];E["tire_lr"].mesh.position.y=Fe.vLR_y[0];E["tire_lr"].mesh.position.z=Fe.vLR_z[0];E["tire_rr"].mesh.position.x=Fe.vRR_x[0];E["tire_rr"].mesh.position.y=Fe.vRR_y[0];E["tire_rr"].mesh.position.z=Fe.vRR_z[0];E["wheel_lf"].mesh.position.x=Fe.vLF_x[0];E["wheel_lf"].mesh.position.y=Fe.vLF_y[0];E["wheel_lf"].mesh.position.z=Fe.vLF_z[0];E["wheel_rf"].mesh.position.x=Fe.vRF_x[0];E["wheel_rf"].mesh.position.y=Fe.vRF_y[0];E["wheel_rf"].mesh.position.z=Fe.vRF_z[0];E["wheel_lr"].mesh.position.x=Fe.vLR_x[0];E["wheel_lr"].mesh.position.y=Fe.vLR_y[0];E["wheel_lr"].mesh.position.z=Fe.vLR_z[0];E["wheel_rr"].mesh.position.x=Fe.vRR_x[0];E["wheel_rr"].mesh.position.y=Fe.vRR_y[0];E["wheel_rr"].mesh.position.z=Fe.vRR_z[0]}function je(){Z();var e=[0,0,0];var t="transmission_hub_front";{var n=L[t].meta.offset;e[0]=n[0]+Fe.vLF_x[0];e[1]=n[1]+ge;e[2]=n[2]+be;E[t].mesh.position.x=e[0];E[t].mesh.position.y=e[1];E[t].mesh.position.z=e[2];J(t,e)}t="transmission_hub_rear";{var n=L[t].meta.offset;e[0]=n[0]+Fe.vLR_x[0];e[1]=n[1]+ge;e[2]=n[2]+be;E[t].mesh.position.x=e[0];E[t].mesh.position.y=e[1];E[t].mesh.position.z=e[2];J(t,e)}t="transmission_main";{var n=L[t].meta.offset;e[0]=n[0]+Fe.vLF_x[0];e[1]=n[1]+ge;e[2]=n[2]+be;E[t].mesh.position.x=e[0];E[t].mesh.position.y=e[1];E[t].mesh.position.z=e[2];J(t,e)}t="transmission_drive_shaft";{var n=L[t].meta.offset;e[0]=n[0]+Fe.vLF_x[0];e[1]=n[1]+ge;e[2]=n[2]+be;E[t].mesh.position.x=e[0];E[t].mesh.position.y=e[1];E[t].mesh.position.z=e[2];J(t,e)}Se()}function Se(){let e=null;e="transmission_hub_front";{var t=w[e].meta.metric.width;var n=Le.C_y[0];var o=(n-t)/2;let a=w[e].meta.deform.width.y_min_box[0][1];let s=w[e].meta.deform.width.y_min_box[1][1];if(a-o>s+o)console.log("degenerate transmission_hub_front ymin");if(a-o>s+o)throw"degenerate transmission_hub_front ymin";let m=w[e].meta.deform.width.y_max_box[0][1];let l=w[e].meta.deform.width.y_max_box[1][1];if(m-o>l+o)console.log("degenerate transmission_hub_front ymax");if(m-o>l+o)throw"degenerate transmission_hub_front ymax";var r=g[e].mesh.geometry.clone();vec=r.attributes.position.array;cnt=r.attributes.position.count;for(i in R.range(0,cnt)){x=vec[i*3+0];y=vec[i*3+1];z=vec[i*3+2];f=null;if(y<=a)y-=o;if(a<y&&y<s)f=(y-a)/(s-a);if(a<y&&y<s)y+=(1-f)*-o+f*0;if(y>=l)y+=o;if(m<y&&y<l)f=(y-m)/(l-m);if(m<y&&y<l)y+=(1-f)*0+f*o;vec[i*3+1]=y}E[e].mesh.geometry=r.clone()}e="transmission_hub_rear";{var t=w[e].meta.metric.width;var n=Le.C_y[0];var o=(n-t)/2;let a=w[e].meta.deform.width.y_min_box[0][1];let s=w[e].meta.deform.width.y_min_box[1][1];if(a-o>s+o)console.log("degenerate transmission_hub_rear ymin");if(a-o>s+o)throw"degenerate transmission_hub_rear ymin";let m=w[e].meta.deform.width.y_max_box[0][1];let l=w[e].meta.deform.width.y_max_box[1][1];if(m-o>l+o)console.log("degenerate transmission_hub_rear ymax");if(m-o>l+o)throw"degenerate transmission_hub_rear ymax";var r=g[e].mesh.geometry.clone();vec=r.attributes.position.array;cnt=r.attributes.position.count;for(i in R.range(0,cnt)){x=vec[i*3+0];y=vec[i*3+1];z=vec[i*3+2];f=null;if(y<=a)y-=o;if(a<y&&y<s)f=(y-a)/(s-a);if(a<y&&y<s)y+=(1-f)*-o+f*0;if(y>=l)y+=o;if(m<y&&y<l)f=(y-m)/(l-m);if(m<y&&y<l)y+=(1-f)*0+f*o;vec[i*3+1]=y}E[e].mesh.geometry=r.clone()}e="transmission_drive_shaft";{var t=w[e].meta.metric.length;let n=L["transmission_main"].meta.point.origin.pos;let o=L["transmission_hub_rear"].meta.point.shaft.pos;px=o[0]-n[0];py=o[1]-n[1];pz=o[2]-n[2];var s=Math.sqrt(px*px+py*py+pz*pz);var m=(s-t)/2;let l=w[e].meta.deform.length.x_equal_box[0];let _=w[e].meta.deform.length.x_equal_box[1];let d=l[0];let c=_[0];if(c+m<d-m)console.log("degenerate transmission_drive_shaft");if(c+m<d-m)throw"degenerate transmission_drive_shaft";var r=g[e].mesh.geometry.clone();vec=r.attributes.position.array;cnt=r.attributes.position.count;for(i in R.range(0,cnt)){x=vec[i*3+0];y=vec[i*3+1];z=vec[i*3+2];if(x<=d)x-=m;else if(x>=c)x+=m;else{let e=(x-d)/(c-d);x+=(1-e)*-m+e*m}vec[i*3+0]=x}let h=w[e].meta.bbox[0][0];for(i in R.range(0,cnt))vec[i*3+0]+=m-h;u=[1,0,0];vx=o[0]-n[0];vy=o[1]-n[1];vz=o[2]-n[2];vm=Math.sqrt(vx*vx+vy*vy+vz*vz);v=[vx/vm,vy/vm,vz/vm];let f=Quaternion.fromBetweenVectors(u,v);for(i in R.range(0,cnt)){a=[vec[i*3+0],vec[i*3+1],vec[i*3+2]];b=f.rotateVector(a);vec[i*3+0]=b[0]+h;vec[i*3+1]=b[1];vec[i*3+2]=b[2]}E[e].mesh.geometry=r.clone()}}function Xe(){name="frame";{var e=w[name].meta.metric.length;var t=Le.C_x[0];var n=(t-e)/2;let m=w[name].meta.deform.length.x_min_box[0][0];let l=w[name].meta.deform.length.x_min_box[1][0];if(m-n>l+n)console.log("degenerate frame xmin");let _=w[name].meta.deform.length.x_max_box[0][0];let d=w[name].meta.deform.length.x_max_box[1][0];if(_-n>d+n)console.log("degenerate frame xmax");var o=w[name].meta.metric.width;var r=Le.C_y[0];var a=(r-o)/2;let c=w[name].meta.deform.width.y_min_box[0][1];let h=w[name].meta.deform.width.y_min_box[1][1];if(c-a>h+a)console.log("degenerate frame ymin");let u=w[name].meta.deform.width.y_max_box[0][1];let v=w[name].meta.deform.width.y_max_box[1][1];if(u-a>v+a)console.log("degenerate frame ymax");var s=g[name].mesh.geometry.clone();vec=s.attributes.position.array;cnt=s.attributes.position.count;for(i in R.range(0,cnt)){x=vec[i*3+0];y=vec[i*3+1];z=vec[i*3+2];f=null;if(x<=m)x-=n;if(m<x&&x<l)f=(x-m)/(l-m);if(m<x&&x<l)x+=(1-f)*-n+f*0;if(x>=d)x+=n;if(_<x&&x<d)f=(x-_)/(d-_);if(_<x&&x<d)x+=(1-f)*0+f*n;vec[i*3+0]=x;if(y<=c)y-=a;if(c<y&&y<h)f=(y-c)/(h-c);if(c<y&&y<h)y+=(1-f)*-a+f*0;if(y>=v)y+=a;if(u<y&&y<v)f=(y-u)/(v-u);if(u<y&&y<v)y+=(1-f)*0+f*a;vec[i*3+1]=y}E[name].mesh.geometry=s.clone()}}function Pe(){name="sheet_metal";{var e=w[name].meta.metric.length;var t=Le.C_x[0];var n=(t-e)/2;let m=w[name].meta.deform.length.x_min_box[0][0];let l=w[name].meta.deform.length.x_min_box[1][0];if(m-n>l+n)console.log("degenerate sheet_metal xmin");let _=w[name].meta.deform.length.x_max_box[0][0];let d=w[name].meta.deform.length.x_max_box[1][0];if(_-n>d+n)console.log("degenerate sheet_metal xmax");var o=w[name].meta.metric.width;var r=Le.C_y[0];var a=(r-o)/2;let c=w[name].meta.deform.width.y_min_box[0][1];let h=w[name].meta.deform.width.y_min_box[1][1];if(c-a>h+a)console.log("degenerate sheet_metal ymin");let u=w[name].meta.deform.width.y_max_box[0][1];let v=w[name].meta.deform.width.y_max_box[1][1];if(u-a>v+a)console.log("degenerate sheet_metal ymax");var s=g[name].mesh.geometry.clone();vec=s.attributes.position.array;cnt=s.attributes.position.count;for(i in R.range(0,cnt)){x=vec[i*3+0];y=vec[i*3+1];z=vec[i*3+2];f=null;if(x<=m)x-=n;if(m<x&&x<l)f=(x-m)/(l-m);if(m<x&&x<l)x+=(1-f)*-n+f*0;if(x>=d)x+=n;if(_<x&&x<d)f=(x-_)/(d-_);if(_<x&&x<d)x+=(1-f)*0+f*n;vec[i*3+0]=x;if(y<=c)y-=a;if(c<y&&y<h)f=(y-c)/(h-c);if(c<y&&y<h)y+=(1-f)*-a+f*0;if(y>=v)y+=a;if(u<y&&y<v)f=(y-u)/(v-u);if(u<y&&y<v)y+=(1-f)*0+f*a;vec[i*3+1]=y}E[name].mesh.geometry=s.clone()}}function We(e){var t=document.getElementById("param_"+e.dv);var n=document.createElement("label");n.innerHTML=e.description;var i=document.createElement("br");var o=document.createElement("input");o.type="range";o.id=e.dv+"_slider";o.min=e.min;o.max=e.max;o.step=e.step;o.value=e.value;o.oninput=e.oninput();var r=document.createElement("em");r.id=e.dv+"_label";r.style="font-style: normal";r.innerHTML=e.value;t.appendChild(n);t.appendChild(i);t.appendChild(o);t.appendChild(r)}We({dv:"C_x",description:"Tire contact point length",value:Le.C_x[0],min:150,max:300,step:10,oninput:function(){return function(){Le.C_x=parseFloat(this.value);document.getElementById("C_x_label").innerHTML=Le.C_x[0];Be();Ie();Ve();je();Xe();Pe();l.render(s,o)}}});We({dv:"C_y",description:"Tire contact point width",value:Le.C_y[0],min:150,max:250,step:10,oninput:function(){return function(){Le.C_y=parseFloat(this.value);document.getElementById("C_y_label").innerHTML=Le.C_y[0];Be();Ie();Ve();je();Xe();Pe();l.render(s,o)}}});We({dv:"T_w",description:"Tire width",value:Le.T_w[0],min:10,max:50,step:2,oninput:function(){return function(){Le.T_w=parseFloat(this.value);document.getElementById("T_w_label").innerHTML=Le.T_w[0];Be();Ie();Ve();l.render(s,o)}}});We({dv:"T_d",description:"Tire diameter",value:Le.T_d[0],min:40,max:100,step:5,oninput:function(){return function(){Le.T_d=parseFloat(this.value);document.getElementById("T_d_label").innerHTML=Le.T_d[0];document.getElementById("T_h_label").innerHTML=Le.T_h[0];document.getElementById("H_d_label").innerHTML=Le.H_d[0];document.getElementById("T_h_slider").value=Le.T_h[0];document.getElementById("H_d_slider").value=Le.H_d[0];Be();Ie();Ve();l.render(s,o)}}});We({dv:"T_d_f",description:"Tire diameter blend factor",value:we.T_d_f,min:0,max:1,step:.1,oninput:function(){return function(){we.T_d_f=parseFloat(this.value);document.getElementById("T_d_f_label").innerHTML=we.T_d_f}}});We({dv:"H_d",description:"Hub diameter",value:Le.H_d[0],min:10,max:70,step:5,oninput:function(){return function(){Le.H_d=parseFloat(this.value);document.getElementById("H_d_label").innerHTML=Le.H_d[0];document.getElementById("T_h_label").innerHTML=Le.T_h[0];document.getElementById("T_d_label").innerHTML=Le.T_d[0];document.getElementById("T_h_slider").value=Le.T_h[0];document.getElementById("T_d_slider").value=Le.T_d[0];Be();Ie();Ve();l.render(s,o)}}});We({dv:"H_d_f",description:"Hub diameter blend factor",value:we.H_d_f,min:0,max:1,step:.1,oninput:function(){return function(){we.H_d_f=parseFloat(this.value);document.getElementById("H_d_f_label").innerHTML=we.H_d_f}}});We({dv:"T_h",description:"Tire sidewall height",value:Le.T_h[0],min:3,max:20,step:2,oninput:function(){return function(){Le.T_h=parseFloat(this.value);document.getElementById("T_h_label").innerHTML=Le.T_h[0];document.getElementById("H_d_label").innerHTML=Le.H_d[0];document.getElementById("T_d_label").innerHTML=Le.T_d[0];document.getElementById("H_d_slider").value=Le.H_d[0];document.getElementById("T_d_slider").value=Le.T_d[0];Be();Ie();Ve();l.render(s,o)}}});We({dv:"T_h_f",description:"Tire sidewall height blend factor",value:we.T_h_f,min:0,max:1,step:.1,oninput:function(){return function(){we.T_h_f=parseFloat(this.value);document.getElementById("T_h_f_label").innerHTML=we.T_h_f}}});setTimeout(function(){Se()},2e3);
